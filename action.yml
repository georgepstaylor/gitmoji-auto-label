---
name: Auto create gitmoji labels
description: This action automatically creates gitmoji labels JIT

inputs:
    GITHUB_TOKEN:
        description: 'GitHub token'
        required: true

runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get all Gitmojis
      id: gitmojis
      shell: bash
      run: |
           curl -s https://gitmoji.dev/api/gitmojis | jq '.gitmojis[].emoji' > gitmojis.txt

    - name: Get gitmoji from PR title
      id: get-gitmoji
      shell: bash
      run: |
           gitmojis=$(cat gitmojis.txt)
           gitmoji=$(echo "${{ github.event.pull_request.title }}" | cut -d ' ' -f1)
           if [[ ! $gitmojis == *"$gitmoji"* ]]; then
             echo "Invalid gitmoji prefix in PR title. Please use a valid gitmoji prefix."
           else
             echo "gitmoji=$gitmoji" >> $GITHUB_OUTPUT
           fi

    - name: Create label if not exists
      id: create-label
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
      run: |
          gh label list | grep -q ${gitmoji}_gitmoji || gh label create ${{steps.outputs.get-gitmoji.outputs.gitmoji}}_gitmoji -c '$(openssl rand -hex 3)' -d "PRs with ${{steps.outputs.get-gitmoji.outputs.gitmoji}}_gitmoji"

    - name: remove labels ending in _gitmoji from PR
      id: remove-label
      shell: bash
      env:
          GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
      run: |
          gh pr checkout ${{ github.event.pull_request.number }}
          gh pr view --json labels -q '.labels[] | select(.name | endswith("_gitmoji")) | .name' | tr -d '"' | while read -r label; do
            gh pr edit --remove-label $label
          done
    - name: Add label to PR
      id: add-label
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
      run: |
          gh pr checkout ${{ github.event.pull_request.number }}
          gh pr edit --add-label ${{steps.outputs.get-gitmoji.outputs.gitmoji}}_gitmoji

branding:
    icon: 'check-circle'
    color: 'green'